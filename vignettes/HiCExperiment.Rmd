---
title: "Introduction to HiCExperiment"
author: "Jacques Serizay"
date: "`r Sys.Date()`"
output: 
    BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{Introduction to HiCExperiment}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r opts, eval = TRUE, echo=FALSE, results="hide", warning=FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>", 
    crop = NULL
)
suppressPackageStartupMessages({
    library(dplyr)
    library(GenomicRanges)
    library(HiContactsData)
    library(HiCExperiment)
})
```

# The `HiCExperiment` class

`HiCExperiment` package implements the new `HiCExperiment` S4 class. It is build 
on pre-existing Bioconductor classes, namely `InteractionSet` and `ContactMatrix` 
(`Lun, Perry & Ing-Simmons, F1000Research 2016`), and leverages them to 
import locally stored Hi-C matrix files. It further provides **analytical** 
and **visualization** tools to investigate contact maps directly in `R`. 

```{r load_lib}
library(HiCExperiment)
showClass("HiCExperiment")
hic <- contacts_yeast()
hic
```

```{r graph, eval = TRUE, echo=FALSE, out.width='100%'}
knitr::include_graphics(
   "https://raw.githubusercontent.com/js2264/HiCExperiment/master/man/figures/HiCExperiment_data-structure.png"
)
```

# Basics: importing `.(m)cool`, `.hic` or HiC-Pro-generated files as `HiCExperiment` objects

## Import methods

The implemented `import()` methods allow one to import Hi-C matrix files in R as 
`HiCExperiment` objects.

```{r import, eval = FALSE}
hic <- import("path-to-cool/mcool/hic/HiC-Pro-file")
```

To give real-life examples, we use the `HiContactsData` package to get access 
to a range of toy datasets available from the `ExperimentHub`. 

```{r evaled_import}
library(HiContactsData)
cool_file <- HiContactsData('yeast_wt', format = 'cool')
import(cool_file, format = 'cool')
```

## Supporting file classes 

There are currently three main standards to store Hi-C matrices in files:

- `.(m)cool` files
- `.hic` files
- `.matrix` and `.bed` files: generated by HiC-Pro.

Three supporting classes were specifically created to ensure that each of these 
file structures would be properly parsed into `HiCExperiment` objects: 

- `CoolFile` 
- `HicFile`
- `HicproFile`

For each object, an optional `pairsFile` can be associated and linked to the 
contact matrix file when imported as a `HiCExperiment` object.

```{r many_imports}
## --- CoolFile
pairs_file <- HiContactsData('yeast_wt', format = 'pairs.gz')
coolf <- CoolFile(cool_file, pairsFile = pairs_file)
coolf
import(coolf)
import(pairsFile(coolf), format = 'pairs')

## --- HicFile
hic_file <- HiContactsData('yeast_wt', format = 'hic')
hicf <- HicFile(hic_file, pairsFile = pairs_file)
hicf
import(hicf)
import(pairsFile(hicf), format = 'pairs')

## --- HicproFile
hicpro_matrix_file <- HiContactsData('yeast_wt', format = 'hicpro_matrix')
hicpro_regions_file <- HiContactsData('yeast_wt', format = 'hicpro_bed')
hicprof <- HicproFile(hicpro_matrix_file, bed = hicpro_regions_file)
hicprof
import(hicprof)
```

# Import arguments

## Querying subsets of Hi-C matrix files

The `focus` argument is used to specifically import contacts within a genomic 
locus of interest. 

```{r focus}
range <- 'I:20000-80000' # range of interest
hic <- import(cool_file, format = 'cool',  focus = range)
hic
focus(hic)
```

_Note:_  
Querying subsets of HiC-Pro formatted matrices is currently not 
supported. HiC-Pro formatted matrices will systematically be fully imported in 
memory when imported. 

One can also extract a count matrix from a Hi-C matrix file that is *not* 
centered at the diagonal. To do this, specify a couple of coordinates in the 
`focus` argument using a character string formatted as `"...|..."`: 

```{r asym}
hic <- import(cool_file, format = 'cool', focus = 'II:0-500000|II:100000-600000')
focus(hic)
```

## Multi-resolution Hi-C matrix files

`import()` works with `.mcool` and multi-resolution `.hic` files as well: 
in this case, the user can specify the `resolution` at which count values are recovered. 

```{r mcool}
mcool_file <- HiContactsData('yeast_wt', format = 'mcool')
range <- 'II:0-800000' # range of interest
lsCoolResolutions(mcool_file, verbose = TRUE)
hic <- import(mcool_file, format = 'cool', focus = range, resolution = 2000)
hic
```

# HiCExperiment accessors 

## Slots

Slots for a `HiCExperiment` object can be accessed using the following `getters`: 

```{r slots}
fileName(hic)
focus(hic)
resolutions(hic)
resolution(hic)
interactions(hic)
scores(hic)
tail(scores(hic, 1))
tail(scores(hic, 'balanced'))
topologicalFeatures(hic)
pairsFile(hic)
metadata(hic)
```

Several extra functions are available as well: 

```{r extra}
seqinfo(hic) ## To recover the `Seqinfo` object from the `.(m)cool` file
bins(hic) ## To bin the genome at the current resolution
regions(hic) ## To extract unique regions of the contact matrix
anchors(hic) ## To extract "first" and "second" anchors for each interaction
```

## Slot setters

### Scores 

Add any `scores` metric using a numerical vector. 

```{r scores}
scores(hic, 'random') <- runif(length(hic))
scores(hic)
tail(scores(hic, 'random'))
```

### Features 

Add `topologicalFeatures` using `GRanges` or `Pairs`. 

```{r features}
topologicalFeatures(hic, 'viewpoints') <- GRanges("II:300000-320000")
topologicalFeatures(hic)
topologicalFeatures(hic, 'viewpoints')
```

## Coercing `HiCExperiment`

Using the `as()` function, `HiCExperiment` can be coerced in `GInteractions`, 
`ContactMatrix` and `matrix` seamlessly.

```{r as}
as(hic, "GInteractions")
as(hic, "ContactMatrix")
as(hic, "matrix")[1:10, 1:10]
as(hic, "data.frame")[1:10, ]
```

# Importing pairs files

Pairs files typically contain chimeric pairs (filtered after mapping), 
corresponding to loci that have been religated together after restriction 
enzyme digestion. 
Such files have a variety of standards. 
 
- The `.pairs` file format, supported by the 4DN consortium: <ID> <chr1> <pos1> <chr2> <pos2> <str1> <str2> [<frag1> <frag2>]
- The pairs format generated by Juicer: [<readname>] <str1> <chr1> <pos1> <frag1> <str2> <chr2> <pos2> <frag2> [<score>] [<mapq1> <mapq2>] [<mapq1> <cigar1> <sequence1> <mapq2> <cigar2> <sequence2> <readname1> <readname2>]
- The `.(all)validPairs` file format, defined in the HiC-Pro pipeline: <ID> <chr1> <pos1> <str1> <chr2> <pos2> <str2> <isize> <frag1> <frag2> <mapq1> <mapq2> [<allele-specific info>]

Pairs in any of these different formats are automatically detected and imported 
in R with the `import` function: 

```{r pairs}
import(pairs_file, format = 'pairs')
```

# Session info

```{r session}
sessionInfo()
```
